<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SuS Clan ‚Äì XP Tracker</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a32; --muted:#8aa0c7; --text:#e8eefc; --accent:#ff9800; --accent-2:#ffc107;
      --border: #243054; --chip:#1b2542; --ok:#2ecc71; --warn:#f39c12; --err: #ff5252;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#0a0f1f,#0a0f1f 60%, #0e1530);
      color:var(--text); font: 14px/1.5 system-ui, -apple-system, sans-serif;
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{ width:min(1100px, 100%); display:grid; gap:16px; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
    
    header.card{ padding:16px 18px; display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
    .title{ display:flex; align-items:center; gap:10px; font-weight:700; font-size: 1.2em; color: var(--accent); }
    
    button{
      background:linear-gradient(45deg, var(--accent), var(--accent-2)); color:#081225; border:0; border-radius:8px; font-weight:700;
      padding:8px 16px; cursor:pointer; transition:.2s;
    }
    button:hover{ transform:translateY(-1px); filter: brightness(1.1); }
    button:disabled { opacity: 0.5; cursor: wait; }

    .table-wrap{ overflow:auto }
    table{ width:100%; border-collapse:separate; border-spacing:0 }
    thead th{
      position:sticky; top:0; background:rgba(15,23,48,.95); backdrop-filter: blur(6px);
      text-align:left; font-weight:700; padding:12px; border-bottom:1px solid var(--border); white-space:nowrap;
    }
    tbody td{ padding:12px; border-bottom:1px dashed #1e2a4f; vertical-align:middle; }
    tr:hover td{ background:#0f1730 }

    .name{ font-weight:700; color: var(--accent-2); }
    .mono{ font-family: ui-monospace, monospace; font-size: 1.1em; }
    
    /* Input Locked XP */
    .locked-input {
        background: #0a0f1f; border: 1px solid var(--border); color: var(--muted);
        padding: 5px 10px; border-radius: 6px; width: 130px; text-align: right; font-family: monospace;
    }
    .locked-input:focus { border-color: var(--accent); color: #fff; outline: none; }

    .plus { color: var(--ok); font-weight: bold; }
    .neutral { color: var(--muted); }
    .center{ text-align:center; padding:24px }
    .hidden{ display:none !important }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div class="title">üõ°Ô∏è SuS Clan XP Tracker</div>
      <div>
        <button id="btnReload">C·∫≠p nh·∫≠t d·ªØ li·ªáu</button>
      </div>
    </header>

    <section class="card table-wrap">
      <div class="center" id="loading">ƒêang k·∫øt n·ªëi t·ªõi server Curse of Aros...</div>
      
      <table id="table" class="hidden">
        <thead>
          <tr>
            <th>#</th>
            <th>Th√†nh Vi√™n</th>
            <th>Current XP (Hi·ªán t·∫°i)</th>
            <th>Locked XP (M·ªëc ban ƒë·∫ßu)</th>
            <th>Gained XP (ƒê√£ c√†y)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <footer class="card" style="padding:12px 16px; font-size:12px; color:var(--muted); text-align: center;">
      D·ªØ li·ªáu Locked XP ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p s·∫µn theo danh s√°ch.
    </footer>
  </div>

 <script>
    // --- DANH S√ÅCH TH√ÄNH VI√äN V√Ä XP KH·ªûI ƒêI·ªÇM ---
    // T√¥i ƒë√£ chuy·ªÉn ƒë·ªïi danh s√°ch c·ªßa b·∫°n th√†nh code ·ªü ƒë√¢y
    const CLAN_DATA = [
        { name: "SuS TraDaVN", start: 45361534920 },
        { name: "SuS Zet DiY", start: 39084720587 },
        { name: "SuS Dominate", start: 38450414228 },
        { name: "SuS QuangTong", start: 35569912243 },
        { name: "SuS t autumn t", start: 26753499820 },
        { name: "SuS Karma", start: 32822171477 },
        { name: "SuS tienma", start: 18232356437 },
        { name: "SuS Daedra", start: 11805772350 },
        { name: "SuS GuarDian", start: 16929364157 },
        { name: "SuS Yoshe DiY", start: 6342424017 },
        { name: "SuS Nightly", start: 7313042667 },
        { name: "SuS Hung buda", start: 4883952202 },
        { name: "SuS Axolotl", start: 8345765571 },
        { name: "SuS D3fault", start: 4009205331 },
        { name: "SuS Skill", start: 5604750109 },
        { name: "SuS Merlon", start: 4349818322 },
        { name: "SuS MicaelQuan", start: 4788178973 },
        { name: "SuS Eupto", start: 3066982450 },
        { name: "SuS UnknownX", start: 3942788125 },
        { name: "SuS Bobross", start: 5216233384 },
        { name: "SuS HibikiVN", start: 1586069982 },
        { name: "SuS Zeta", start: 1772622138 },
        { name: "SuS HuyKhoi VN", start: 4251076795 },
        { name: "SuS Maxmillnos", start: 2251216584 },
        { name: "SuS J97 Bo Con", start: 2622015974 },
        { name: "SuS Bun Cha VN", start: 1724494062 },
        { name: "SuS GoG1t0", start: 2363285870 },
        { name: "SuS Naow", start: 2699422340 },
        { name: "SuS DuyKhanh", start: 2629377805 },
        { name: "SuS VuSua VN", start: 1712168220 },
        { name: "SuS SHIELDHERO", start: 1311790623 },
        { name: "SuS lucky", start: 2680717114 },
        { name: "SuS Uruneeshi", start: 1496485944 },
        { name: "SuS NoSlackSky", start: 1600803318 },
        { name: "SuS mehdipro", start: 1719139440 },
        { name: "SuS TraDao VN", start: 1678100063 },
        { name: "SuS SadSaiki", start: 719832247 }
    ];
    // -------------------------------------

    const els = {
      btnReload: document.getElementById('btnReload'),
      loading: document.getElementById('loading'),
      table: document.getElementById('table'),
      tbody: document.getElementById('tbody'),
    };

    function fmtNumber(n){
      return Number(n).toLocaleString('en-US');
    }

    async function fetchData(){
      els.loading.classList.remove('hidden');
      els.table.classList.add('hidden');
      els.btnReload.disabled = true;
      els.btnReload.innerText = "ƒêang t·∫£i...";

      try{
        // L·∫•y danh s√°ch t√™n ƒë·ªÉ g·ª≠i API
        const nameList = CLAN_DATA.map(m => encodeURIComponent(m.name)).join(',');

        // G·ªçi API Backend
        const res = await fetch(`/api/track?users=${nameList}`);
        if(!res.ok) throw new Error('L·ªói k·∫øt n·ªëi API');
        
        const apiData = await res.json();
        
        // H·ª£p nh·∫•t d·ªØ li·ªáu API v·ªõi d·ªØ li·ªáu Start XP c·ªßa Clan
        const mergedData = CLAN_DATA.map(member => {
            // T√¨m k·∫øt qu·∫£ t·ª´ API t∆∞∆°ng ·ª©ng v·ªõi t√™n
            const apiResult = apiData.find(d => d.name === member.name) || { xp: 0, found: false };
            return {
                ...member, // Gi·ªØ l·∫°i start xp
                currentXP: apiResult.xp,
                found: apiResult.found
            };
        });
        
        // S·∫Øp x·∫øp theo Gained XP (Ai c√†y nhi·ªÅu nh·∫•t l√™n ƒë·∫ßu)
        // N·∫øu mu·ªën x·∫øp theo T·ªïng XP th√¨ ƒë·ªïi th√†nh b.currentXP - a.currentXP
        mergedData.sort((a, b) => {
            const gainedA = a.currentXP - (getStoredLocked(a.name) || a.start);
            const gainedB = b.currentXP - (getStoredLocked(b.name) || b.start);
            return gainedB - gainedA;
        });

        renderTable(mergedData);

      } catch(err){
        console.error(err);
        els.loading.textContent = 'L·ªói: ' + err.message;
      } finally {
        els.loading.classList.add('hidden');
        els.table.classList.remove('hidden');
        els.btnReload.disabled = false;
        els.btnReload.innerText = "C·∫≠p nh·∫≠t d·ªØ li·ªáu";
      }
    }

    // H√†m l·∫•y Locked XP: ∆Øu ti√™n LocalStorage > M·∫∑c ƒë·ªãnh trong code
    function getStoredLocked(name){
        const stored = localStorage.getItem(`locked_xp_${name}`);
        return stored ? parseInt(stored) : null;
    }

    function renderTable(data){
      els.tbody.innerHTML = '';
      
      data.forEach((row, index) => {
        const tr = document.createElement('tr');
        
        // Logic ch·ªçn Locked XP:
        // 1. N·∫øu ng∆∞·ªùi d√πng ƒë√£ t·ª´ng s·ª≠a tay tr√™n web -> L·∫•y s·ªë ƒë√£ s·ª≠a (trong LocalStorage)
        // 2. N·∫øu ch∆∞a s·ª≠a g√¨ c·∫£ -> L·∫•y s·ªë m·∫∑c ƒë·ªãnh b·∫°n cung c·∫•p (row.start)
        let lockedVal = getStoredLocked(row.name);
        if (lockedVal === null) lockedVal = row.start;

        const currentXP = row.currentXP;
        const gainedXP = currentXP - lockedVal;

        // T·∫°o n·ªôi dung HTML
        tr.innerHTML = `
            <td class="muted">${index + 1}</td>
            <td class="name">${row.name}</td>
            <td class="mono" style="color:#fff">${fmtNumber(currentXP)}</td>
            <td>
                <input type="number" 
                       class="locked-input" 
                       value="${lockedVal}" 
                       onchange="window.updateRow('${row.name}', ${currentXP}, this.value, 'gained_${index}')"
                       onclick="this.select()"
                />
            </td>
            <td class="mono ${gainedXP > 0 ? 'plus' : 'neutral'}" id="gained_${index}">
                ${gainedXP > 0 ? '+' : ''}${fmtNumber(gainedXP)}
            </td>
        `;

        els.tbody.appendChild(tr);
      });
    }

    // H√†m c·∫≠p nh·∫≠t khi ng∆∞·ªùi d√πng nh·∫≠p tay s·ªë m·ªõi
    window.updateRow = function(name, currentXP, newLockedVal, gainedId) {
        const lockedVal = parseInt(newLockedVal) || 0;
        
        // L∆∞u s·ªë m·ªõi v√†o tr√¨nh duy·ªát
        localStorage.setItem(`locked_xp_${name}`, lockedVal);

        // T√≠nh l·∫°i hi·ªÉn th·ªã
        const gained = currentXP - lockedVal;
        const gainedEl = document.getElementById(gainedId);
        
        gainedEl.innerText = (gained > 0 ? "+" : "") + fmtNumber(gained);
        
        // ƒê·ªïi m√†u
        if(gained > 0) gainedEl.className = "mono plus";
        else gainedEl.className = "mono neutral";
    };

    els.btnReload.addEventListener('click', fetchData);
    fetchData();
  </script>
</body>
</html>
